<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student File Manager — KumonEduvault</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #10ceeb;
      --card: #fff;
      --muted: #6b7280;
      --accent: #0f1724;
      --primary: #0b74d1;
      --radius: 10px;
      --border: #e6eef6;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}

    /* Header */
    header{background:#fff;padding:14px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:700}
    nav ul{display:flex;gap:12px;list-style:none;margin:0;padding:0}
    nav a{padding:8px 10px;border-radius:8px;color:var(--muted)}
    nav a.active{background:#f3f7fb;color:var(--accent)}

    /* Layout */
    .wrap{max-width:1200px;margin:22px auto;padding:0 18px;display:grid;grid-template-columns:300px 1fr;gap:20px}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}

    /* Left panel */
    .panel{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border)}
    .panel h3{margin:0 0 10px;font-size:15px}
    .filters{display:flex;flex-direction:column;gap:10px}
    .filters input, .filters select{padding:10px;border-radius:8px;border:1px solid var(--border);font-size:14px}

    /* Upload area */
    .upload{
      margin-bottom:12px;border:2px dashed #dfeffb;border-radius:8px;padding:12px;text-align:center;background:linear-gradient(180deg,#fff,#fbfdff)
    }
    .upload.dragover{border-color:var(--primary);box-shadow:0 6px 18px rgba(11,116,209,0.06)}
    .upload input[type="file"]{display:none}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:700}

    /* Right: file area */
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
    .search{flex:1;display:flex;gap:10px}
    .search input{flex:1;padding:10px;border-radius:8px;border:1px solid var(--border)}
    .controls{display:flex;gap:8px}

    /* Grid of file cards */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .file-card{background:var(--card);border-radius:10px;padding:12px;border:1px solid var(--border);box-shadow:0 8px 20px rgba(15,23,42,0.03);display:flex;flex-direction:column;gap:10px}
    .thumb{height:120px;border-radius:8px;background:linear-gradient(180deg,#eee,#e6e6e6);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:14px}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:13px}
    .fname{font-weight:600;word-break:break-word}
    .fsmall{color:var(--muted);font-size:13px}
    .card-actions{display:flex;gap:8px;flex-wrap:wrap}
    .action-btn{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:13px}

    /* footer */
    .footer{margin-top:12px;font-size:13px;color:var(--muted)}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(3,6,12,0.45);display:none;align-items:center;justify-content:center;z-index:999}
    .modal{width:880px;max-width:96%;background:var(--card);border-radius:10px;padding:16px;border:1px solid var(--border);box-shadow:0 20px 60px rgba(10,16,30,0.5)}
    .modal .content{display:flex;gap:14px}
    .modal .left{flex:1}
    .modal .right{width:320px}
    .close-x{position:absolute;right:16px;top:10px;border:none;background:transparent;font-size:18px;cursor:pointer}

    /* small */
    @media (max-width:540px){ .modal .content{flex-direction:column} .thumb{height:160px} }
  </style>
</head>
<body>
  <header>
    <div class="brand">KumonEduvault — Student Files</div>
    <nav aria-label="top nav">
      <ul>
        <li><a href="StudentHomePage.html">Home</a></li>
        <li><a href="#" class="active">Files</a></li>
        <li><a href="#">Activity</a></li>
        <li><a href="#">Resources</a></li>
      </ul>
    </nav>
  </header>

  <main class="wrap" role="main">
    <!-- LEFT -->
    <aside class="panel" aria-label="File actions and filters">
      <h3>Upload & Filters</h3>

      <div class="upload" id="upload-area" tabindex="0" aria-label="Drag and drop files here">
        <p style="margin:8px 0 10px">Drag & drop files here, or</p>
        <label for="file-input" class="btn" style="cursor:pointer">Select files</label>
        <input id="file-input" type="file" multiple aria-label="Choose files to upload">
        <div style="margin-top:10px;font-size:13px;color:var(--muted)">You can add a category after selecting files.</div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input id="name-edit" placeholder="Optional name for upload" style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--border)">
        <select id="category-edit" style="padding:10px;border-radius:8px;border:1px solid var(--border)">
          <option value="">Category</option>
          <option>Worksheet</option>
          <option>Exam</option>
          <option>Notes</option>
          <option>Other</option>
        </select>
      </div>

      <h3 style="margin-top:12px">Quick Filters</h3>
      <div class="filters" style="margin-bottom:8px">
        <input id="filter-search" placeholder="Search by filename" aria-label="Search files">
        <select id="filter-type" aria-label="Filter by type">
          <option value="">All types</option>
          <option value="image">Images</option>
          <option value="text">Text</option>
          <option value="pdf">PDF</option>
          <option value="other">Other</option>
        </select>
        <select id="filter-category" aria-label="Filter by category">
          <option value="">All categories</option>
          <option>Worksheet</option>
          <option>Exam</option>
          <option>Notes</option>
          <option>Other</option>
        </select>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="btn-bulk-delete" class="btn" style="background:#f04343">Delete Selected</button>
        <button id="btn-export-meta" class="btn" style="background:#fff;color:var(--primary);border:1px solid var(--primary)">Export CSV</button>
      </div>

      <div class="footer" style="margin-top:14px">
        <div><strong>Storage:</strong> <span id="storage-usage">0 files</span></div>
        <div style="margin-top:6px;color:var(--muted)">Files stored in your browser for demo only.</div>
      </div>
    </aside>

    <!-- RIGHT -->
    <section>
      <div class="topbar">
        <div class="search">
          <input id="global-search" placeholder="Search files or categories..." aria-label="Global search">
          <button id="clear-search" class="action-btn">Clear</button>
        </div>
        <div class="controls">
          <label style="display:flex;align-items:center;gap:6px"><input id="select-all" type="checkbox"> Select all</label>
        </div>
      </div>

      <div id="grid" class="grid" aria-live="polite" aria-label="File list">
        <!-- file cards -->
      </div>
    </section>
  </main>

  <!-- preview modal -->
  <div class="modal-backdrop" id="modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" style="position:relative">
      <button class="close-x" id="modal-close" aria-label="Close preview">&times;</button>
      <div class="content">
        <div class="left">
          <div class="thumb" id="preview-thumb">Preview</div>
        </div>
        <div class="right">
          <h3 id="modal-title">File name</h3>
          <div class="meta" style="margin-top:8px">
            <div class="fsmall" id="modal-type">type</div>
            <div class="fsmall" id="modal-size">size</div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="download-btn">Download</button>
            <button class="action-btn" id="rename-btn">Rename</button>
            <button class="action-btn" id="delete-btn" style="background:#fff;border:1px solid #ffdfe0">Delete</button>
          </div>

          <div style="margin-top:12px">
            <label class="fsmall">Category</label>
            <select id="modal-category" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);margin-top:6px"></select>
          </div>

          <div style="margin-top:12px">
            <label class="fsmall">Notes</label>
            <textarea id="modal-notes" rows="4" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);"></textarea>
            <div style="margin-top:8px"><button class="btn" id="save-meta">Save</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
const grid = document.getElementById('grid');
const fileInput = document.getElementById('file-input');
const uploadArea = document.getElementById('upload-area');
const nameEdit = document.getElementById('name-edit');
const categoryEdit = document.getElementById('category-edit');
const filterType = document.getElementById('filter-type');
const filterCategory = document.getElementById('filter-category');
const filterSearch = document.getElementById('filter-search');
const globalSearch = document.getElementById('global-search');
const clearSearch = document.getElementById('clear-search');
const selectAll = document.getElementById('select-all');
const btnBulkDelete = document.getElementById('btn-bulk-delete');
const btnExportMeta = document.getElementById('btn-export-meta');
const modal = document.getElementById('modal');
const modalClose = document.getElementById('modal-close');
const previewThumb = document.getElementById('preview-thumb');
const modalTitle = document.getElementById('modal-title');
const modalType = document.getElementById('modal-type');
const modalSize = document.getElementById('modal-size');
const downloadBtn = document.getElementById('download-btn');
const renameBtn = document.getElementById('rename-btn');
const deleteBtn = document.getElementById('delete-btn');
const modalCategory = document.getElementById('modal-category');
const modalNotes = document.getElementById('modal-notes');
const saveMeta = document.getElementById('save-meta');

let files = [];
let currentPreviewId = null;

function humanSize(n){
  if(n < 1024) return n + ' B';
  if(n < 1024*1024) return (n/1024).toFixed(1) + ' KB';
  return (n/(1024*1024)).toFixed(2) + ' MB';
}
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

async function fetchFiles(){
  try{
    const res = await fetch('/api/files');
    if(!res.ok) throw new Error('Failed to load files');
    files = await res.json();
    renderGrid();
  }catch(e){
    grid.innerHTML = '<div style="grid-column:1/-1;padding:18px;background:#fff;border-radius:8px;border:1px solid #eee;text-align:center;color:#888">Failed to load files.</div>';
  }
}

function renderGrid(){
  grid.innerHTML = '';
  if(!files.length){
    grid.innerHTML = '<div style="grid-column:1/-1;padding:18px;background:#fff;border-radius:8px;border:1px solid #eee;text-align:center;color:#888">No files found</div>';
    return;
  }
  files.forEach(f=>{
    const card=document.createElement('div');
    card.className='file-card';
    card.dataset.id=f._id;
    card.innerHTML=`
      <div class="thumb">${renderThumb(f)}</div>
      <div class="meta">
        <div><div class="fname">${escapeHtml(f.originalname||f.name)}</div><div class="fsmall">${f.category||'Uncategorized'}</div></div>
        <div class="fsmall">${humanSize(f.size||0)}</div>
      </div>
      <div class="card-actions">
        <button class="action-btn" data-action="download" data-id="${f._id}">Download</button>
      </div>`;
    grid.appendChild(card);
  });
}

function renderThumb(f){
  if(f.mimetype && f.mimetype.startsWith('image/')) return `<img src="/uploads/${f.filename}" style="width:100%;height:120px;object-fit:cover;border-radius:6px">`;
  if(f.mimetype && f.mimetype.includes('pdf')) return `<div style="font-weight:700">PDF</div>`;
  return `<div style="font-weight:700">${(f.mimetype||'FILE').split('/')[0].toUpperCase()}</div>`;
}

fileInput.addEventListener('change', e=>{
  if(e.target.files.length) uploadFile(e.target.files[0]);
});

async function uploadFile(file){
  const formData=new FormData();
  formData.append('file',file);
  formData.append('studentEmail','student1@example.com');
  formData.append('category',categoryEdit.value);
  formData.append('name',nameEdit.value||file.name);
  try{
    const res=await fetch('/upload',{method:'POST',body:formData});
    if(!res.ok) throw new Error('Upload failed');
    await fetchFiles();
    fileInput.value='';
    nameEdit.value='';
    categoryEdit.value='';
  }catch(e){
    alert('Upload failed.');
  }
}

grid.addEventListener('click',e=>{
  const btn=e.target.closest('button');
  if(!btn)return;
  const id=btn.dataset.id;
  if(btn.dataset.action==='download') window.open(`/uploads/${id}`,'_blank');
});

uploadArea.addEventListener('click',()=>fileInput.click());
fetchFiles();
</script>

</body>
</html>
