<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Instructor File Management — KumonEduvault</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f3f8fb;
      --panel: #fff;
      --muted: #6b7280;
      --accent: #0f1724;
      --primary: #0b74d1;
      --danger: #e23b3b;
      --border: #e6eef6;
      --radius: 10px;
      --shadow: 0 10px 30px rgba(12,20,30,0.06);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}

    /* Header */
    header{background:var(--panel);padding:14px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40}
    .brand{font-weight:700}
    nav ul{display:flex;gap:12px;list-style:none;margin:0;padding:0}
    nav a{padding:8px 10px;border-radius:8px;color:var(--muted)}

    /* Layout */
    .container{max-width:1200px;margin:24px auto;padding:0 18px;display:grid;grid-template-columns:300px 1fr 360px;gap:20px;align-items:start}
    @media (max-width:1100px){ .container{grid-template-columns:1fr 360px} .center-col{order:1} .right-col{order:2}}
    @media (max-width:760px){ .container{grid-template-columns:1fr} }

    .panel{background:var(--panel);border-radius:12px;padding:14px;border:1px solid var(--border);box-shadow:var(--shadow)}

    /* Left column: classes & quick */
    .left-col .section-title{font-weight:700;margin:0 0 10px}
    .class-list{display:flex;flex-direction:column;gap:10px}
    .class-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:#fff;border:1px solid var(--border);cursor:pointer}
    .class-item .meta{margin-left:auto;color:var(--muted);font-size:13px}

    /* Centre: file list and actions */
    .toolbar{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .upload-area{flex:1;min-height:84px;border-radius:10px;border:2px dashed #dfeffb;background:linear-gradient(180deg,#fff,#fbfdff);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:12px;cursor:pointer}
    .upload-area.dragover{border-color:var(--primary);box-shadow:0 8px 26px rgba(11,116,209,0.06)}
    .btn{padding:10px 14px;border-radius:8px;border:none;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .controls{display:flex;gap:8px;align-items:center}

    .filters{display:flex;gap:8px;align-items:center}
    .filters input, .filters select{padding:10px;border-radius:8px;border:1px solid var(--border);background:#fff}

    /* Files table */
    .table-wrap{overflow:auto;border-radius:10px;border:1px solid var(--border);background:#fff}
    table{width:100%;border-collapse:collapse}
    thead th{background:#fbfeff;padding:12px;text-align:left;font-weight:700;border-bottom:1px solid var(--border)}
    tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle}
    tbody tr:hover{background:linear-gradient(90deg,rgba(11,116,209,0.02),transparent)}
    .file-actions button{margin-left:8px;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}

    /* Right column: preview & metadata */
    .right-col .section-title{font-weight:700;margin:0 0 10px}
    .preview{height:220px;border-radius:8px;background:linear-gradient(180deg,#eee,#e6e6e6);display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:600}
    .meta-row{display:flex;gap:8px;margin-top:10px}
    .meta-row label{font-size:13px;color:var(--muted)}
    textarea{width:100%;min-height:80px;border-radius:8px;border:1px solid var(--border);padding:10px}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(3,6,12,0.45);display:none;align-items:center;justify-content:center;z-index:999}
    .modal{width:640px;max-width:96%;background:var(--panel);border-radius:10px;padding:16px;border:1px solid var(--border);box-shadow:0 20px 60px rgba(10,16,30,0.5)}
    .modal h3{margin:0 0 12px}
    .modal .row{display:flex;gap:8px}
    .modal .row .col{flex:1}
    .close-x{position:absolute;right:14px;top:12px;border:none;background:transparent;font-size:18px;cursor:pointer}

    .small{font-size:13px;color:var(--muted)}
    .badge{padding:6px 8px;border-radius:8px;background:#fff;border:1px solid var(--border);font-size:13px}

    /* responsive small */
    @media (max-width:540px){
      .preview{height:140px}
      .upload-area{min-height:72px}
    }

  </style>
</head>
<body>
  <header>
    <div class="brand" style="padding-left:18px">KumonEduvault — Instructor Files</div>
    <nav aria-label="top-nav" style="padding-right:18px">
      <ul style="display:flex;gap:12px;list-style:none;margin:0;padding:0">
        <li><a href="#">Home</a></li>
        <li><a href="#" class="active">Files</a></li>
        <li><a href="#">Students</a></li>
        <li><a href="#">Classes</a></li>
      </ul>
    </nav>
  </header>

  <main class="container" role="main">
    <!-- LEFT -->
    <aside class="panel left-col" aria-label="Classes & quick actions">
      <div>
        <h4 class="section-title">Classes</h4>
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <input id="new-class-name" placeholder="New class name" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border)">
          <button id="btn-add-class" class="btn secondary">Add</button>
        </div>
        <div class="class-list" id="class-list">
          <!-- classes inserted by JS -->
        </div>
      </div>

      <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)">

      <div style="margin-top:6px">
        <h4 class="section-title">Quick Actions</h4>
        <button id="btn-bulk-move" class="btn" style="width:100%;margin-top:6px">Move Selected to...</button>
        <button id="btn-bulk-delete" class="btn" style="width:100%;margin-top:6px;background:var(--danger)">Delete Selected</button>
        <button id="btn-export-meta" class="btn secondary" style="width:100%;margin-top:6px">Export Metadata</button>
      </div>
    </aside>

    <!-- CENTER -->
    <section class="panel center-col" aria-label="Files">
      <div class="toolbar">
        <div id="upload-area" class="upload-area" tabindex="0" title="Click or drop files to upload">
          <div style="font-weight:600">Upload files</div>
          <div class="small">Drag & drop here or click to browse</div>
          <input id="file-input" type="file" multiple style="display:none" aria-hidden="true">
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;min-width:260px">
          <div class="filters">
            <input id="search" placeholder="Search filename / class / notes">
            <select id="filter-class">
              <option value="">All classes</option>
            </select>
            <select id="filter-type">
              <option value="">All types</option>
              <option value="image">Image</option>
              <option value="pdf">PDF</option>
              <option value="text">Text</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div style="display:flex;gap:8px">
            <label style="display:flex;align-items:center;gap:6px"><input id="select-all" type="checkbox"> Select All</label>
            <button id="btn-clear" class="btn secondary">Clear Filters</button>
          </div>
        </div>
      </div>

      <div class="table-wrap" role="table" aria-label="Files table">
        <table id="files-table">
          <thead>
            <tr>
              <th style="width:36px"></th>
              <th>File</th>
              <th>Class</th>
              <th>Uploaded</th>
              <th>Size</th>
              <th style="width:260px">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- rows populated by JS -->
          </tbody>
        </table>
      </div>

    </section>

    <!-- RIGHT -->
    <aside class="panel right-col" aria-label="Preview & metadata">
      <h4 class="section-title">Preview</h4>
      <div id="preview" class="preview">Select a file to preview</div>

      <div class="meta-row" style="margin-top:12px">
        <div style="flex:1">
          <label class="small">File name</label>
          <div id="meta-name" class="badge" style="margin-top:6px">—</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label class="small">Class</label>
        <select id="meta-class" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);margin-top:6px"></select>
      </div>

      <div style="margin-top:10px">
        <label class="small">Share with students</label>
        <div id="students-list" style="margin-top:6px;display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto"></div>
      </div>

      <div style="margin-top:12px">
        <label class="small">Notes</label>
        <textarea id="meta-notes" placeholder="Add instructions or notes..."></textarea>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btn-save-meta" class="btn">Save</button>
        <button id="btn-download" class="btn secondary">Download</button>
        <button id="btn-delete" class="btn" style="background:var(--danger)">Delete</button>
      </div>
    </aside>
  </main>

  <!-- Modal: Move to class -->
  <div class="modal-backdrop" id="modal-move" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="move-title">
      <button class="close-x" id="move-close" aria-label="close">&times;</button>
      <h3 id="move-title">Move Selected Files</h3>
      <div style="margin-top:8px">
        <label class="small">Select destination class</label>
        <select id="move-target" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid var(--border)"></select>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
        <button id="move-cancel" class="btn secondary">Cancel</button>
        <button id="move-confirm" class="btn">Move</button>
      </div>
    </div>
  </div>

  <script>
    /* -------------------------
       Demo Instructor File Manager
       - Client-side only
       - Files stored in localStorage (dataURL preview for small files/images)
       - Instructor functionality: assign to classes, share with students
       ------------------------- */

    const STORAGE_KEY = 'kumon_instructor_files_v1';

    // sample classes and students
    let classes = [
      { id: 'cl1', name: 'Mathematics - Grade 4', students: [
          {id:'s1', name:'Ana Reyes', email:'ana@school.edu'},
          {id:'s2', name:'Carlos Dela Cruz', email:'carlos@school.edu'}
        ]
      },
      { id: 'cl2', name: 'Reading - Grade 4', students: [
          {id:'s3', name:'Liza Santos', email:'liza@school.edu'},
          {id:'s4', name:'Miguel Ramos', email:'miguel@school.edu'}
        ]
      }
    ];

    // files: { id, name, filename, type, size, dataUrl?, classId?, notes, sharedWith: [studentIds], createdAt }
    let files = loadFiles();

    // DOM refs
    const classListEl = document.getElementById('class-list');
    const btnAddClass = document.getElementById('btn-add-class');
    const newClassName = document.getElementById('new-class-name');

    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const filterClass = document.getElementById('filter-class');
    const filterType = document.getElementById('filter-type');
    const searchEl = document.getElementById('search');
    const selectAll = document.getElementById('select-all');
    const filesTableBody = document.querySelector('#files-table tbody');
    const btnBulkMove = document.getElementById('btn-bulk-move');
    const btnBulkDelete = document.getElementById('btn-bulk-delete');
    const btnExportMeta = document.getElementById('btn-export-meta');

    const previewEl = document.getElementById('preview');
    const metaName = document.getElementById('meta-name');
    const metaClass = document.getElementById('meta-class');
    const studentsList = document.getElementById('students-list');
    const metaNotes = document.getElementById('meta-notes');
    const btnSaveMeta = document.getElementById('btn-save-meta');
    const btnDownload = document.getElementById('btn-download');
    const btnDelete = document.getElementById('btn-delete');

    const modalMove = document.getElementById('modal-move');
    const moveTarget = document.getElementById('move-target');
    const moveConfirm = document.getElementById('move-confirm');
    const moveCancel = document.getElementById('move-cancel');
    const moveClose = document.getElementById('move-close');

    let selectedFileId = null;
    let selectedIds = new Set();

    /* ---------- persistence ---------- */
    function loadFiles(){
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      } catch(e){ return []; }
    }
    function saveFiles(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(files));
      renderFilesTable();
    }

    /* ---------- initial render functions ---------- */
    function renderClasses(){
      classListEl.innerHTML = '';
      classes.forEach(cl => {
        const div = document.createElement('div');
        div.className = 'class-item';
        div.dataset.id = cl.id;
        div.innerHTML = `<div style="font-weight:600">${escapeHtml(cl.name)}</div><div class="meta">${cl.students.length} students</div>`;
        div.addEventListener('click', () => {
          filterClass.value = cl.id;
          renderFilesTable();
        });
        classListEl.appendChild(div);
      });
      // fill filter selects
      filterClass.innerHTML = '<option value="">All classes</option>';
      metaClass.innerHTML = '<option value="">Unassigned</option>';
      moveTarget.innerHTML = '<option value="">Select class</option>';
      classes.forEach(cl => {
        const o = document.createElement('option'); o.value = cl.id; o.textContent = cl.name; filterClass.appendChild(o);
        const o2 = o.cloneNode(true); metaClass.appendChild(o2);
        const o3 = o.cloneNode(true); moveTarget.appendChild(o3);
      });
    }

    function renderFilesTable(){
      filesTableBody.innerHTML = '';
      const q = (searchEl.value || '').toLowerCase().trim();
      const fClass = filterClass.value;
      const fType = filterType.value;

      const filtered = files.filter(f => {
        if(fClass && f.classId !== fClass) return false;
        if(fType){
          if(fType === 'image' && !f.type.startsWith('image/')) return false;
          if(fType === 'pdf' && !f.type.includes('pdf')) return false;
          if(fType === 'text' && !f.type.startsWith('text/')) return false;
          if(fType === 'other' && (f.type.startsWith('image/') || f.type.includes('pdf') || f.type.startsWith('text/'))) return false;
        }
        if(q){
          const hay = (f.name + ' ' + (f.filename||'') + ' ' + (getClassName(f.classId)||'') + ' ' + (f.notes||'')).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      if(filtered.length === 0){
        filesTableBody.innerHTML = `<tr><td colspan="6" style="padding:20px;text-align:center;color:var(--muted)">No files found</td></tr>`;
        return;
      }

      filtered.forEach(f => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="width:36px"><input type="checkbox" class="row-sel" data-id="${f.id}" ${selectedIds.has(f.id) ? 'checked' : ''}></td>
          <td>
            <div style="font-weight:600">${escapeHtml(f.name)}</div>
            <div class="small" style="margin-top:6px">${escapeHtml(f.filename || '')}</div>
          </td>
          <td>${escapeHtml(getClassName(f.classId) || '—')}</td>
          <td class="small">${(new Date(f.createdAt)).toLocaleString()}</td>
          <td class="small">${humanSize(f.size)}</td>
          <td class="file-actions">
            <button class="btn secondary preview-btn" data-id="${f.id}">Preview</button>
            <button class="btn" data-action="assign" data-id="${f.id}">Assign</button>
            <button class="btn" data-action="download" data-id="${f.id}">Download</button>
            <button class="btn" data-action="delete" data-id="${f.id}" style="background:var(--danger)">Delete</button>
          </td>
        `;
        filesTableBody.appendChild(tr);
      });
    }

    function renderPreview(fileId){
      const f = files.find(x => x.id === fileId);
      if(!f){
        previewEl.textContent = 'Select a file to preview';
        metaName.textContent = '—';
        metaClass.value = '';
        studentsList.innerHTML = '';
        metaNotes.value = '';
        selectedFileId = null;
        return;
      }
      selectedFileId = fileId;
      metaName.textContent = f.name;
      metaClass.value = f.classId || '';
      // populate students for that class
      const classObj = classes.find(c => c.id === f.classId) || {students: []};
      studentsList.innerHTML = '';
      classObj.students.forEach(s => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.innerHTML = `<input type="checkbox" data-student="${s.id}" ${ (f.sharedWith||[]).includes(s.id) ? 'checked' : '' }><div style="font-size:14px">${escapeHtml(s.name)}</div>`;
        studentsList.appendChild(label);
      });
      // notes
      metaNotes.value = f.notes || '';

      // preview area: prefer image preview if dataUrl present
      if(f.dataUrl && f.type.startsWith('image/')){
        previewEl.innerHTML = `<img src="${f.dataUrl}" alt="${escapeHtml(f.name)}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px">`;
      } else if(f.dataUrl && f.type.startsWith('text/')){
        // show text preview
        previewEl.innerHTML = `<div style="overflow:auto;padding:12px;text-align:left;max-height:200px;color:var(--muted);white-space:pre-wrap">${escapeHtml(f.textPreview || '')}</div>`;
      } else {
        previewEl.innerHTML = `<div style="font-weight:700">${escapeHtml(f.type.split('/')[0].toUpperCase())}</div>`;
      }
    }

    /* ---------- helpers ---------- */
    function uid(prefix='f'){ return prefix + Math.random().toString(36).slice(2,9); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function getClassName(id){ const c = classes.find(x => x.id === id); return c ? c.name : null; }
    function humanSize(n){
      if(n < 1024) return n + ' B';
      if(n < 1024*1024) return (n/1024).toFixed(1) + ' KB';
      return (n/(1024*1024)).toFixed(2) + ' MB';
    }

    /* ---------- uploading ---------- */
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      if(e.target.files.length) handleFiles(e.target.files);
      fileInput.value = '';
    });

    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', (e) => { uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const dt = e.dataTransfer;
      if(dt && dt.files && dt.files.length) handleFiles(dt.files);
    });

    async function handleFiles(fileList){
      for(const file of Array.from(fileList)){
        // simple file size guard for demo
        if(file.size > 10 * 1024 * 1024){
          if(!confirm(`${file.name} is large (${humanSize(file.size)}). Add anyway?`)) continue;
        }
        const meta = {
          id: uid(),
          name: file.name.replace(/\.[^/.]+$/, ''),
          filename: file.name,
          type: file.type || 'application/octet-stream',
          size: file.size,
          createdAt: Date.now(),
          classId: '', notes: '',
          sharedWith: []
        };
        // read previewable files to dataUrl
        if(meta.type.startsWith('image/') || meta.type.startsWith('text/') || meta.type.includes('pdf')){
          try {
            const dataUrl = await readFileAsDataURL(file);
            meta.dataUrl = dataUrl;
            if(meta.type.startsWith('text/')){
              try {
                const text = await readFileAsText(file);
                meta.textPreview = text.slice(0,200);
              } catch(e){}
            }
          } catch(e){ console.warn('read failed', e); }
        }
        files.unshift(meta);
      }
      saveFiles();
      renderFilesTable();
    }

    function readFileAsDataURL(file){
      return new Promise((res,rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }
    function readFileAsText(file){
      return new Promise((res,rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsText(file);
      });
    }

    /* ---------- table interactions ---------- */
    filesTableBody.addEventListener('change', (e) => {
      const cb = e.target.closest('.row-sel');
      if(cb){
        const id = cb.dataset.id;
        if(cb.checked) selectedIds.add(id); else selectedIds.delete(id);
        updateSelectAllState();
      }
    });

    filesTableBody.addEventListener('click', (e) => {
      const previewBtn = e.target.closest('.preview-btn');
      if(previewBtn){
        const id = previewBtn.dataset.id;
        renderPreview(id);
        return;
      }
      const actionBtn = e.target.closest('button[data-action]');
      if(actionBtn){
        const action = actionBtn.dataset.action;
        const id = actionBtn.dataset.id;
        if(action === 'assign'){
          // open preview and focus assign
          renderPreview(id);
          // focus students list if any
          return;
        } else if(action === 'download'){
          downloadFile(id);
        } else if(action === 'delete'){
          if(confirm('Delete this file?')){
            files = files.filter(f => f.id !== id);
            saveFiles();
            renderPreview(null);
          }
        }
      }
    });

    /* ---------- select all ---------- */
    selectAll.addEventListener('change', () => {
      const cbList = document.querySelectorAll('.row-sel');
      cbList.forEach(cb => {
        cb.checked = selectAll.checked;
        const id = cb.dataset.id;
        if(cb.checked) selectedIds.add(id); else selectedIds.delete(id);
      });
    });

    function updateSelectAllState(){
      const cbList = document.querySelectorAll('.row-sel');
      if(cbList.length === 0) { selectAll.checked = false; return; }
      const allChecked = Array.from(cbList).every(cb => cb.checked);
      selectAll.checked = allChecked;
    }

    /* ---------- bulk actions ---------- */
    btnBulkDelete.addEventListener('click', () => {
      if(selectedIds.size === 0){ alert('No files selected'); return; }
      if(!confirm(`Delete ${selectedIds.size} selected file(s)?`)) return;
      files = files.filter(f => !selectedIds.has(f.id));
      selectedIds.clear();
      saveFiles();
      renderFilesTable();
      renderPreview(null);
    });

    btnBulkMove.addEventListener('click', () => {
      if(selectedIds.size === 0){ alert('No files selected'); return; }
      if(classes.length === 0){ alert('No classes defined'); return; }
      modalMove.style.display = 'flex';
      modalMove.setAttribute('aria-hidden','false');
    });

    moveConfirm.addEventListener('click', () => {
      const target = moveTarget.value;
      if(!target){ alert('Select target class'); return; }
      files.forEach(f => { if(selectedIds.has(f.id)) f.classId = target; });
      selectedIds.clear();
      saveFiles();
      modalMove.style.display = 'none';
      modalMove.setAttribute('aria-hidden','true');
      renderFilesTable();
    });
    moveCancel.addEventListener('click', () => { modalMove.style.display = 'none'; modalMove.setAttribute('aria-hidden','true'); });
    moveClose.addEventListener('click', () => { modalMove.style.display = 'none'; modalMove.setAttribute('aria-hidden','true'); });

    /* ---------- export metadata ---------- */
    btnExportMeta.addEventListener('click', () => {
      if(files.length === 0) { alert('No files'); return; }
      const rows = [['id','name','filename','type','size','class','notes','createdAt']];
      files.forEach(f => rows.push([f.id,f.name,f.filename || '',f.type,f.size, getClassName(f.classId) || '', (f.notes||'').replace(/\n/g,' '), new Date(f.createdAt).toISOString()]));
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'files_metadata.csv'; a.click(); URL.revokeObjectURL(url);
    });

    /* ---------- preview panel actions ---------- */
    btnSaveMeta.addEventListener('click', () => {
      if(!selectedFileId){ alert('Select a file first'); return; }
      const f = files.find(x => x.id === selectedFileId);
      if(!f) return;
      f.classId = metaClass.value || '';
      // collect shared students checkboxes
      const chosen = Array.from(studentsList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.dataset.student);
      f.sharedWith = chosen;
      f.notes = metaNotes.value.trim();
      saveFiles();
      alert('Metadata saved');
      renderFilesTable();
    });

    btnDownload.addEventListener('click', () => {
      if(!selectedFileId){ alert('Select a file first'); return; }
      downloadFile(selectedFileId);
    });

    btnDelete.addEventListener('click', () => {
      if(!selectedFileId){ alert('Select a file first'); return; }
      if(confirm('Delete selected file?')){
        files = files.filter(x => x.id !== selectedFileId);
        saveFiles();
        renderPreview(null);
      }
    });

    /* ---------- utility: download --------- */
    function downloadFile(id){
      const f = files.find(x => x.id === id);
      if(!f) return;
      if(f.dataUrl){
        fetch(f.dataUrl).then(res => res.blob()).then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = f.filename || (f.name + '.bin'); a.click(); URL.revokeObjectURL(url);
        });
      } else {
        // create small placeholder
        const blob = new Blob([`File ${f.name}`], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = f.filename || (f.name + '.txt'); a.click(); URL.revokeObjectURL(url);
      }
    }

    /* ---------- class CRUD ---------- */
    btnAddClass.addEventListener('click', () => {
      const name = newClassName.value.trim();
      if(!name){ alert('Enter a class name'); return; }
      const id = uid('cl');
      classes.push({ id, name, students: []});
      newClassName.value = '';
      renderClasses();
      renderFilesTable();
    });

    /* ---------- row-level select handler (delegated) ---------- */
    // Already wired to table change event for checkboxes.

    /* ---------- search & filters ---------- */
    [searchEl, filterClass, filterType].forEach(el => el.addEventListener('input', renderFilesTable));
    document.getElementById('btn-clear').addEventListener('click', () => {
      searchEl.value = ''; filterClass.value = ''; filterType.value = ''; renderFilesTable();
    });

    /* ---------- helper: when clicking a row checkbox populate selection ---------- */
    // set up event delegation to catch selection clicks for renderPreview
    filesTableBody.addEventListener('dblclick', (e) => {
      const tr = e.target.closest('tr');
      if(!tr) return;
      const ck = tr.querySelector('.row-sel');
      if(ck) ck.checked = !ck.checked;
    });

    // when clicking a preview button we already call renderPreview
    // also allow clicking the file name area to select preview
    filesTableBody.addEventListener('click', (e) => {
      const td = e.target.closest('td');
      if(!td) return;
      const tr = e.target.closest('tr');
      if(!tr) return;
      if(e.target.tagName.toLowerCase() === 'button' || e.target.tagName.toLowerCase() === 'input') return;
      const chk = tr.querySelector('.row-sel');
      const id = chk && chk.dataset.id;
      if(id){
        renderPreview(id);
      }
    });

    /* ---------- preload sample (if empty) ---------- */
    (function initDemoData(){
      if(files.length === 0){
        // small sample file entries
        files.push({
          id: uid(), name: 'Week1 - Fractions', filename: 'fractions.pdf', type: 'application/pdf', size: 23456,
          createdAt: Date.now() - 86400000 * 2, classId: classes[0].id, notes: 'Practice problems', sharedWith: [], dataUrl: '', textPreview: ''
        });
        files.push({
          id: uid(), name: 'Reading Passage', filename: 'reading.txt', type: 'text/plain', size: 2345,
          createdAt: Date.now() - 86400000 * 5, classId: classes[1].id, notes: 'Comprehension', sharedWith: [], dataUrl: '', textPreview: 'This is a short reading passage example...'
        });
        saveFiles();
      }
      renderClasses();
      renderFilesTable();
      renderPreview(null);
    })();

    /* ---------- helper: escape HTML ---------- */
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ---------- initial hooks ---------- */
    // When the page loads, clicking a preview or using filters will show data.
    document.addEventListener('DOMContentLoaded', () => {
      renderClasses();
      renderFilesTable();
    });

    // small UX: clicking on student's checkbox in right panel updates selection in memory but not persisted until Save
    // (save handled in btnSaveMeta)
  </script>
</body>
</html>
