<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Activity & Audit Log</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #10ceeb;
    --card: #ffffff;
    --muted: #5b6b74;
    --accent: #0b74d1;
    --danger: #e23b3b;
    --ok: #16a34a;
    --border: #e6eef6;
    --radius: 12px;
    --maxw: 1200px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#0b1b25;-webkit-font-smoothing:antialiased}
  a{color:var(--accent);text-decoration:none}

  header{max-width:var(--maxw);margin:18px auto;padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
  .brand{font-weight:700;font-size:18px}
  .toolbar{max-width:var(--maxw);margin:0 auto 12px;padding:0 18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}

  .panel{background:var(--card);border-radius:var(--radius);padding:12px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(15,25,35,0.04)}
  .wrap{max-width:var(--maxw);margin:0 auto 28px;padding:0 18px;display:grid;grid-template-columns:320px 1fr;gap:16px}
  @media (max-width:980px){ .wrap{grid-template-columns:1fr} }

  /* left filters */
  .filters{display:flex;flex-direction:column;gap:10px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"], select, input[type="date"], .small-input {
    width:100%;padding:9px;border-radius:8px;border:1px solid var(--border);font-size:14px;background:#fff;
  }
  .small-input { padding:8px 10px }
  .btn{display:inline-block;padding:9px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
  .btn.warn{background:var(--danger)}
  .muted{color:var(--muted);font-size:13px}

  /* right table area */
  .actions-bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
  .left-actions{display:flex;gap:8px;align-items:center}
  .right-actions{display:flex;gap:8px;align-items:center}

  .table-wrap{overflow:auto;border-radius:8px;border:1px solid var(--border)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{background:#fbfdff;padding:12px;text-align:left;font-weight:700;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20}
  tbody td{padding:10px;border-bottom:1px solid var(--border);vertical-align:middle;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  tbody tr:hover{background:#fbfbff}

  .col-small{width:44px;text-align:center}
  .col-time{width:160px}
  .col-type{width:110px}
  .col-user{width:150px}
  .col-actions{width:150px;text-align:right}

  .chip{display:inline-block;padding:6px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-weight:700}
  .sev-info{color:var(--accent)}
  .sev-warn{color:#c67c00}
  .sev-err{color:var(--danger)}

  .page-controls{display:flex;gap:8px;align-items:center;margin-top:10px;justify-content:flex-end}
  .tiny{font-size:13px;color:var(--muted)}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(6,10,14,0.45);display:none;align-items:center;justify-content:center;z-index:999}
  .modal{width:720px;max-width:95%;background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border)}
  .modal h3{margin:0 0 8px}
  .modal pre{max-height:320px;overflow:auto;padding:8px;background:#f6f9fb;border-radius:8px;border:1px solid var(--border)}
  .modal .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}

  /* responsive */
  @media (max-width:660px){
    thead th, tbody td{font-size:13px}
    .col-user{display:none}
    .col-type{display:none}
    .col-actions{text-align:left}
  }
</style>
</head>
<body>

<header>
  <div class="brand">Kumon — Admin Activity Log</div>
  <div class="muted">Audit & events • Local demo</div>
</header>

<div class="toolbar" role="toolbar" aria-label="Global actions">
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <button id="newEvent" class="btn">New Event</button>
    <button id="exportAll" class="btn ghost">Export CSV</button>
    <button id="clearLogs" class="btn ghost">Clear Logs</button>
    <li style="display:inline"><a href="AdminHomePage.html" class="active">Home</a></li>
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <div class="tiny">Showing <strong id="totalCount">0</strong></div>
  </div>
</div>

<main class="wrap" role="main">
  <!-- LEFT: filters -->
  <aside class="panel" aria-label="Filters">
    <h3 style="margin-top:0">Filters</h3>
    <div class="filters">
      <div>
        <label for="filterType">Type</label>
        <select id="filterType">
          <option value="">All</option>
          <option value="system">System</option>
          <option value="upload">Upload</option>
          <option value="test">Test</option>
          <option value="grade">Grade</option>
          <option value="message">Message</option>
        </select>
      </div>

      <div>
        <label for="filterSeverity">Severity</label>
        <select id="filterSeverity">
          <option value="">All</option>
          <option value="info">Info</option>
          <option value="warn">Warning</option>
          <option value="error">Error</option>
        </select>
      </div>

      <div>
        <label for="filterUser">User</label>
        <select id="filterUser"><option value="">All users</option></select>
      </div>

      <div>
        <label for="dateFrom">Date from</label>
        <input id="dateFrom" type="date">
      </div>

      <div>
        <label for="dateTo">Date to</label>
        <input id="dateTo" type="date">
      </div>

      <div>
        <label for="q">Text search</label>
        <input id="q" type="text" placeholder="Search message, file, remarks...">
      </div>

      <div style="display:flex;gap:8px">
        <button id="apply" class="btn">Apply</button>
        <button id="reset" class="btn ghost">Reset</button>
      </div>

      <hr>

      <div>
        <label class="tiny">Visible columns</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <label><input type="checkbox" id="toggleTarget" checked> Target</label>
          <label><input type="checkbox" id="toggleRemarks" checked> Remarks</label>
        </div>
      </div>

    </div>
  </aside>

  <!-- RIGHT: table -->
  <section style="display:flex;flex-direction:column;gap:10px">
    <div class="panel">
      <div class="actions-bar">
        <div class="left-actions">
          <label style="display:flex;align-items:center;gap:8px"><input id="selectAll" type="checkbox"> Select</label>
          <button id="bulkDelete" class="btn ghost">Delete</button>
          <button id="bulkExport" class="btn ghost">Export selected</button>
        </div>

        <div class="right-actions">
          <label class="tiny">Per page</label>
          <select id="perPage" class="small-input" style="width:80px">
            <option>10</option><option>20</option><option>50</option>
          </select>
        </div>
      </div>

      <div class="table-wrap">
        <table id="logTable" aria-label="Activity log table">
          <thead>
            <tr>
              <th class="col-small"></th>
              <th class="col-time">Date</th>
              <th class="col-type">Type</th>
              <th class="col-user">User</th>
              <th class="col-target">Target</th>
              <th>Remarks</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div class="tiny" id="pageInfo">Page 1</div>
        <div class="page-controls">
          <button id="prevPage" class="btn ghost">Prev</button>
          <button id="nextPage" class="btn ghost">Next</button>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- modal -->
<div class="modal-backdrop" id="modal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <button id="modalClose" style="float:right;border:none;background:transparent;font-size:20px;cursor:pointer">×</button>
    <h3 id="modalTitle">Event details</h3>
    <div class="row"><label class="muted" style="min-width:80px">Date</label><div id="mDate" class="muted"></div></div>
    <div class="row"><label class="muted" style="min-width:80px">Type</label><div id="mType"></div></div>
    <div class="row"><label class="muted" style="min-width:80px">User</label><div id="mUser"></div></div>
    <div class="row"><label class="muted" style="min-width:80px">Target</label><div id="mTarget"></div></div>
    <div style="margin-top:8px"><label class="muted">Admin note</label><textarea id="mNote" style="width:100%;height:80px;padding:8px;border:1px solid var(--border);border-radius:8px"></textarea></div>
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
      <button id="mSave" class="btn">Save</button>
      <button id="mDelete" class="btn warn">Delete</button>
    </div>
    <h4 style="margin-top:12px">Event JSON</h4>
    <pre id="mJson" style="white-space:pre-wrap"></pre>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const tableBody = document.querySelector("#logTable tbody");
  const totalCount = document.getElementById("totalCount");

  const filterType = document.getElementById("filterType");
  const filterSeverity = document.getElementById("filterSeverity");
  const filterUser = document.getElementById("filterUser");
  const dateFrom = document.getElementById("dateFrom");
  const dateTo = document.getElementById("dateTo");
  const searchInput = document.getElementById("q");
  const applyBtn = document.getElementById("apply");
  const resetBtn = document.getElementById("reset");

  let allLogs = [];

  // 🔐 Check if admin is logged in
  const admin = JSON.parse(localStorage.getItem("loggedInUser"));
  if (!admin || admin.role !== "admin") {
    alert("You must be logged in as an admin to access this page.");
    window.location.href = "AdminLogin.html";
    return;
  }

  // 🧾 Load logs from MongoDB
  async function loadLogs() {
    try {
      const res = await fetch("http://localhost:5000/admin/logs", {
        credentials: "include",
      });
      if (!res.ok) throw new Error("Failed to fetch logs");
      const logs = await res.json();
      allLogs = Array.isArray(logs) ? logs : [];
      renderTable(allLogs);
      populateUsers(allLogs);
    } catch (err) {
      console.error("[LOAD LOGS ERROR]", err);
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:red;">Error loading activity logs.</td></tr>`;
    }
  }

  // 👥 Populate User dropdown
  function populateUsers(logs) {
    const users = [...new Set(logs.map(l => l.userEmail).filter(Boolean))];
    filterUser.innerHTML = '<option value="">All users</option>';
    users.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u;
      opt.textContent = u;
      filterUser.appendChild(opt);
    });
  }

  // 🧠 Render filtered logs
  function renderTable(logs) {
    tableBody.innerHTML = "";
    if (logs.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No logs found.</td></tr>`;
      totalCount.textContent = "0";
      return;
    }

    totalCount.textContent = logs.length;

    logs.forEach((log, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="col-small">${index + 1}</td>
        <td class="col-time">${new Date(log.timestamp).toLocaleString()}</td>
        <td class="col-type">${log.type || "—"}</td>
        <td class="col-user">${log.userEmail || "—"}</td>
        <td>${log.target || "—"}</td>
        <td>${log.remarks || log.action || "—"}</td>
        <td class="col-actions">
          <button class="btn ghost tiny" onclick='viewDetails(${JSON.stringify(
            log
          )})'>View</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  // 🔍 Apply filters
  function applyFilters() {
    const type = filterType.value;
    const severity = filterSeverity.value;
    const user = filterUser.value;
    const q = searchInput.value.toLowerCase();
    const from = dateFrom.value ? new Date(dateFrom.value) : null;
    const to = dateTo.value ? new Date(dateTo.value) : null;

    const filtered = allLogs.filter(log => {
      const matchType = !type || log.type === type;
      const matchSeverity = !severity || log.severity === severity;
      const matchUser = !user || log.userEmail === user;
      const matchText =
        !q ||
        (log.remarks || log.action || "")
          .toLowerCase()
          .includes(q) ||
        (log.userEmail || "").toLowerCase().includes(q);
      const logDate = new Date(log.timestamp);
      const matchFrom = !from || logDate >= from;
      const matchTo = !to || logDate <= to;

      return (
        matchType &&
        matchSeverity &&
        matchUser &&
        matchText &&
        matchFrom &&
        matchTo
      );
    });

    renderTable(filtered);
  }

  // 🔁 Reset filters
  function resetFilters() {
    filterType.value = "";
    filterSeverity.value = "";
    filterUser.value = "";
    dateFrom.value = "";
    dateTo.value = "";
    searchInput.value = "";
    renderTable(allLogs);
  }

  // 🪟 Modal details
  window.viewDetails = log => {
    const modal = document.getElementById("modal");
    document.getElementById("mDate").textContent = new Date(
      log.timestamp
    ).toLocaleString();
    document.getElementById("mType").textContent = log.type || "—";
    document.getElementById("mUser").textContent = log.userEmail || "—";
    document.getElementById("mTarget").textContent = log.target || "—";
    document.getElementById("mNote").value = log.remarks || log.action || "";
    document.getElementById("mJson").textContent = JSON.stringify(
      log,
      null,
      2
    );
    modal.style.display = "flex";
  };

  document.getElementById("modalClose").onclick = () =>
    (document.getElementById("modal").style.display = "none");

  // 🧩 Bind filter buttons
  applyBtn.addEventListener("click", applyFilters);
  resetBtn.addEventListener("click", resetFilters);

  // 🚀 Load logs on page start
  loadLogs();
});
</script>

</body>
</html>
