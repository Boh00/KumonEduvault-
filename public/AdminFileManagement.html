<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin File Management — KumonEduvault</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f9fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0b1320;
      --primary:#0b74d1;
      --danger:#e23b3b;
      --border:#e7eef6;
      --shadow: 0 8px 28px rgba(12,20,30,0.06);
      --radius:12px;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      --maxw:1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}

    header{background:var(--card);padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
    .brand{font-weight:700}

    .wrap{max-width:var(--maxw);margin:22px auto;padding:0 18px;display:grid;grid-template-columns:320px 1fr 360px;gap:18px;align-items:start}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr 360px}}
    @media (max-width:780px){.wrap{grid-template-columns:1fr}}

    .panel{background:var(--card);border-radius:var(--radius);padding:14px;border:1px solid var(--border);box-shadow:var(--shadow)}
    h3{margin:0 0 12px;font-size:16px}

    /* Left - controls */
    .upload-area{border:2px dashed #dfeefb;border-radius:10px;padding:14px;text-align:center;background:linear-gradient(180deg,#fff,#fbfdff);cursor:pointer}
    .upload-area.dragover{border-color:var(--primary);box-shadow:0 8px 26px rgba(11,116,209,0.06)}
    input[type=file]{display:none}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:none;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .small{font-size:13px;color:var(--muted)}

    .filters{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .filters input,.filters select{padding:9px;border-radius:8px;border:1px solid var(--border);font-size:14px}

    /* center - table */
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .search{flex:1;display:flex;gap:8px}
    .search input{flex:1;padding:10px;border-radius:8px;border:1px solid var(--border)}
    .table-wrap{border-radius:10px;border:1px solid var(--border);overflow:auto;background:var(--card)}
    table{width:100%;border-collapse:collapse}
    thead th{background:#fbfeff;padding:12px;text-align:left;font-weight:700;border-bottom:1px solid var(--border)}
    tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle}
    tbody tr:hover{background:linear-gradient(90deg,rgba(11,116,209,0.02),transparent)}

    .row-actions button{margin-left:8px;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
    .badge{display:inline-block;padding:6px 8px;border-radius:8px;background:#fff;border:1px solid var(--border);font-weight:600;font-size:13px}

    /* right - logs & users */
    .users-list{display:flex;flex-direction:column;gap:8px}
    .user-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:#fff;border:1px solid var(--border)}
    .log{font-size:13px;color:var(--muted);max-height:260px;overflow:auto;padding-right:6px}
    .muted{color:var(--muted)}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(3,6,12,0.45);display:none;align-items:center;justify-content:center;z-index:999}
    .modal{width:720px;max-width:96%;background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);box-shadow:0 24px 60px rgba(10,16,30,0.5)}
    .modal .content{display:grid;grid-template-columns:1fr 320px;gap:12px}
    .preview-box{height:340px;border-radius:8px;background:linear-gradient(180deg,#eee,#e6e6e6);display:flex;align-items:center;justify-content:center;color:var(--muted);overflow:auto}
    .close-x{position:absolute;right:12px;top:8px;border:none;background:transparent;font-size:18px;cursor:pointer}

    footer.small{font-size:13px;color:var(--muted);margin-top:8px}

    /* responsive tweaks */
    @media (max-width:980px){
      .modal .content{grid-template-columns:1fr}
      .preview-box{height:220px}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">KumonEduvault — Admin File Manager</div>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="export-log" class="btn ghost">Export Logs</button>
      <button id="clear-storage" class="btn ghost">Clear Demo Data</button>
    </div>
  </header>

  <main class="wrap" role="main">
    <!-- LEFT: upload + filters -->
    <aside class="panel" aria-label="Upload and filters">
      <h3>Upload Files</h3>
      <div id="uploadArea" class="upload-area" tabindex="0" aria-label="Drag files here">
        <div style="font-weight:600">Drag & drop files here</div>
        <div class="small" style="margin-top:8px">or</div>
        <label class="btn" for="fileInput" style="margin-top:10px;cursor:pointer">Browse files</label>
        <input id="fileInput" type="file" multiple />
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <input id="uploadName" placeholder="Optional title" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border)">
        <select id="uploadOwner" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
          <!-- owners populated by JS -->
        </select>
      </div>

      <div class="filters">
        <h3 style="margin-top:10px">Filters</h3>
        <input id="filterSearch" placeholder="Search filename / notes / owner" />
        <select id="filterType">
          <option value="">All types</option>
          <option value="image">Images</option>
          <option value="text">Text</option>
          <option value="pdf">PDF</option>
          <option value="other">Other</option>
        </select>
        <select id="filterOwner">
          <option value="">All owners</option>
        </select>
        <div style="display:flex;gap:8px">
          <button id="clearFilters" class="btn ghost">Clear</button>
          <button id="bulk-delete" class="btn" style="background:var(--danger)">Delete Selected</button>
        </div>
      </div>
    </aside>

    <!-- CENTER: files table -->
    <section class="panel" aria-label="File list">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="search" style="width:420px">
            <input id="globalSearch" placeholder="Quick search..." />
            <button id="clearSearch" class="btn ghost">Clear</button>
          </div>
          <select id="sortBy" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
            <option value="createdAt">Newest</option>
            <option value="name">Name</option>
            <option value="size">Size</option>
          </select>
        </div>
        <div>
          <button id="exportMeta" class="btn ghost">Export Metadata</button>
          <button id="openLogs" class="btn">View Audit Log</button>
        </div>
      </div>

      <div class="table-wrap" role="table" aria-label="Files table">
        <table id="filesTable" aria-live="polite">
          <thead>
            <tr>
              <th style="width:36px"><input id="selectAll" type="checkbox"></th>
              <th>Title</th>
              <th>Filename</th>
              <th>Type</th>
              <th>Owner</th>
              <th>Uploaded</th>
              <th>Size</th>
              <th style="width:220px">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <footer class="small" id="stats">0 files</footer>
    </section>

    <!-- RIGHT: users + logs (summary) -->
    <aside class="panel" aria-label="Users and logs">
      <h3>Users</h3>
      <div class="users-list" id="usersList"></div>

      <h3 style="margin-top:12px">Recent Audit</h3>
      <div class="log" id="logList"><div class="small muted">No actions yet.</div></div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="addUserBtn" class="btn ghost">+ Add User</button>
        <button id="exportUsers" class="btn ghost">Export Users</button>
      </div>
    </aside>
  </main>

  <!-- Modal: preview / edit file -->
  <div class="modal-backdrop" id="modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" style="position:relative">
      <button class="close-x" id="modalClose" aria-label="Close">&times;</button>
      <h3 id="modalTitle">File preview</h3>
      <div class="content">
        <div>
          <div class="preview-box" id="previewBox">Preview</div>

          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button id="modalDownload" class="btn">Download</button>
            <button id="modalRename" class="btn ghost">Rename</button>
            <button id="modalDelete" class="btn" style="background:var(--danger)">Delete</button>
            <button id="modalSave" class="btn">Save Changes</button>
          </div>
        </div>

        <aside style="padding-left:6px">
          <label class="small">Title</label>
          <input id="modalTitleInput" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)">

          <label class="small" style="margin-top:8px">Owner</label>
          <select id="modalOwner" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)"></select>

          <label class="small" style="margin-top:8px">Access (who can view)</label>
          <div id="modalAccess" style="display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto;margin-top:6px"></div>

          <label class="small" style="margin-top:8px">Notes</label>
          <textarea id="modalNotes" style="width:100%;min-height:80px;border-radius:8px;border:1px solid var(--border);padding:8px"></textarea>
        </aside>
      </div>
    </div>
  </div>

  <script>
    /* ADMIN FILE MANAGEMENT - client-only demo
       - Files, Users, Logs stored in localStorage
       - Replace persistence with real APIs for production
    */

    const FILE_KEY = 'kumon_admin_files_v1';
    const USER_KEY = 'kumon_admin_users_v1';
    const LOG_KEY  = 'kumon_admin_logs_v1';

    // DOM
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadName = document.getElementById('uploadName');
    const uploadOwner = document.getElementById('uploadOwner');

    const filterSearch = document.getElementById('filterSearch');
    const filterType = document.getElementById('filterType');
    const filterOwner = document.getElementById('filterOwner');
    const clearFilters = document.getElementById('clearFilters');
    const bulkDeleteBtn = document.getElementById('bulk-delete');
    const selectAll = document.getElementById('selectAll');

    const globalSearch = document.getElementById('globalSearch');
    const clearSearch = document.getElementById('clearSearch');
    const sortBy = document.getElementById('sortBy');
    const filesTableBody = document.querySelector('#filesTable tbody');
    const stats = document.getElementById('stats');

    const usersList = document.getElementById('usersList');
    const addUserBtn = document.getElementById('addUserBtn');
    const exportUsersBtn = document.getElementById('exportUsers');
    const logList = document.getElementById('logList');
    const openLogsBtn = document.getElementById('openLogs');
    const exportLogBtn = document.getElementById('export-log');
    const exportMetaBtn = document.getElementById('exportMeta');
    const clearStorageBtn = document.getElementById('clear-storage');

    // modal elements
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    const previewBox = document.getElementById('previewBox');
    const modalTitleInput = document.getElementById('modalTitleInput');
    const modalOwner = document.getElementById('modalOwner');
    const modalAccess = document.getElementById('modalAccess');
    const modalNotes = document.getElementById('modalNotes');
    const modalDownload = document.getElementById('modalDownload');
    const modalRename = document.getElementById('modalRename');
    const modalDelete = document.getElementById('modalDelete');
    const modalSave = document.getElementById('modalSave');

    // state
    let files = load(FILE_KEY) || []; // file objects
    let users = load(USER_KEY) || []; // {id,name,email,role}
    let logs  = load(LOG_KEY)  || []; // {ts,action,meta}
    let selectedIds = new Set();
    let activeFileId = null;

    // init sample data if empty
    (function initSample(){
      if(users.length === 0){
        users = [
          {id:'u_admin', name:'Admin User', email:'admin@kumon.edu', role:'Admin'},
          {id:'u_instructor', name:'Instructor One', email:'inst1@school.edu', role:'Instructor'},
          {id:'u_student', name:'Student One', email:'student1@school.edu', role:'Student'}
        ];
        save(USER_KEY, users);
      }
      if(files.length === 0){
        files = [
          { id: uid(), name:'Week1-Fractions', filename:'fractions.pdf', type:'application/pdf', size:23456, owner:users[0].id, access:[users[1].id], notes:'Practice test', createdAt: Date.now()-86400000*2, dataUrl:''},
          { id: uid(), name:'Reading-Text', filename:'reading.txt', type:'text/plain', size:2048, owner:users[1].id, access:[users[2].id], notes:'Reading passage', createdAt: Date.now()-86400000*6, dataUrl:'', textPreview:'This is a demo reading passage...'}
        ];
        save(FILE_KEY, files);
        appendLog('Initialized sample files');
      }
      renderAll();
    })();

    // ------------ helpers ------------
    function uid(prefix='f'){ return prefix + Math.random().toString(36).slice(2,9); }
    function now(){ return new Date().toISOString().replace('T',' ').slice(0,19); }
    function save(key, data){ localStorage.setItem(key, JSON.stringify(data)); }
    function load(key){ try{ return JSON.parse(localStorage.getItem(key)); } catch(e){ return null; } }
    function appendLog(action, meta=''){ logs.unshift({ts: now(), action, meta}); save(LOG_KEY, logs); renderLogs(); }
    function humanSize(n){
      if(!n) return '—';
      if(n < 1024) return n + ' B';
      if(n < 1024*1024) return (n/1024).toFixed(1) + ' KB';
      return (n/(1024*1024)).toFixed(2) + ' MB';
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function findUser(id){ return users.find(u => u.id === id) || null; }

    // ------------ upload handling ------------
    uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', e => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', async e => {
      e.preventDefault(); uploadArea.classList.remove('dragover');
      if(e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) await handleFileList(e.dataTransfer.files);
    });
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async e => { if(e.target.files && e.target.files.length) await handleFileList(e.target.files); fileInput.value=''; });

    async function handleFileList(fileList){
      const defaultTitle = (uploadName.value || '').trim();
      const defaultOwner = uploadOwner.value || (users[0] && users[0].id);
      for(const file of Array.from(fileList)){
        const id = uid();
        const meta = {
          id,
          name: defaultTitle || file.name.replace(/\.[^/.]+$/,''),
          filename: file.name,
          type: file.type || 'application/octet-stream',
          size: file.size,
          owner: defaultOwner,
          access: [], // who can view (ids)
          notes: '',
          createdAt: Date.now(),
          dataUrl: '',
          textPreview: ''
        };
        // small files -> read preview
        try {
          if(meta.type.startsWith('image/') || meta.type.startsWith('text/') || meta.type.includes('pdf')){
            const dataUrl = await fileToDataURL(file);
            meta.dataUrl = dataUrl;
            if(meta.type.startsWith('text/')){
              try { meta.textPreview = await readFileAsText(file); } catch(e) {}
            }
          }
        } catch(e){ console.warn('read err', e); }
        files.unshift(meta);
        appendLog(`Uploaded file: ${meta.filename}`, meta.id);
      }
      uploadName.value = '';
      save(FILE_KEY, files);
      renderAll();
    }

    function fileToDataURL(file){
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }
    function readFileAsText(file){
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsText(file);
      });
    }

    // ------------ rendering ------------
    function renderAll(){
      renderUsers();
      populateOwnerSelectors();
      renderTable();
      renderLogs();
      stats.textContent = files.length + ' files';
    }

    function renderUsers(){
      usersList.innerHTML = '';
      users.forEach(u => {
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `<div><strong>${escapeHtml(u.name)}</strong><div class="small">${escapeHtml(u.email)} • ${escapeHtml(u.role)}</div></div>
                         <div style="display:flex;gap:6px">
                           <button class="btn ghost" data-action="edit-user" data-id="${u.id}">Edit</button>
                           <button class="btn" data-action="del-user" data-id="${u.id}" style="background:${u.role==='Admin'?'#555':varDanger()};">Del</button>
                         </div>`;
        usersList.appendChild(div);
      });
    }
    function varDanger(){ return 'var(--danger)'; } // small helper for inlined style above

    function populateOwnerSelectors(){
      // uploadOwner, filterOwner, modalOwner
      [uploadOwner, filterOwner, modalOwner].forEach(sel => {
        sel.innerHTML = '';
        users.forEach(u => {
          const opt = document.createElement('option'); opt.value = u.id; opt.textContent = `${u.name} (${u.role})`; sel.appendChild(opt);
        });
      });
      if(users.length && !uploadOwner.value) uploadOwner.value = users[0].id;
      if(users.length && !filterOwner.value) filterOwner.value = '';
    }

    function renderTable(){
      filesTableBody.innerHTML = '';
      const qGlobal = (globalSearch.value || '').toLowerCase().trim();
      const qFilter = (filterSearch.value || '').toLowerCase().trim();
      const typeFilter = filterType.value;
      const ownerFilter = filterOwner.value;
      const sortVal = sortBy.value;

      let list = files.filter(f => {
        if(typeFilter){
          if(typeFilter === 'image' && !f.type.startsWith('image/')) return false;
          if(typeFilter === 'text' && !f.type.startsWith('text/')) return false;
          if(typeFilter === 'pdf' && !f.type.includes('pdf')) return false;
          if(typeFilter === 'other' && (f.type.startsWith('image/') || f.type.startsWith('text/') || f.type.includes('pdf'))) return false;
        }
        if(ownerFilter && f.owner !== ownerFilter) return false;
        if(qFilter && !(f.name.toLowerCase().includes(qFilter) || (f.notes||'').toLowerCase().includes(qFilter))) return false;
        if(qGlobal && !(f.name.toLowerCase().includes(qGlobal) || (f.filename||'').toLowerCase().includes(qGlobal) || (f.notes||'').toLowerCase().includes(qGlobal))) return false;
        return true;
      });

      list.sort((a,b) => {
        if(sortVal === 'createdAt') return b.createdAt - a.createdAt;
        if(sortVal === 'name') return a.name.localeCompare(b.name);
        if(sortVal === 'size') return b.size - a.size;
        return 0;
      });

      if(list.length === 0){
        filesTableBody.innerHTML = `<tr><td colspan="8" style="padding:18px;text-align:center;color:var(--muted)">No files found</td></tr>`;
        return;
      }

      list.forEach(f => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="row-chk" data-id="${f.id}" ${selectedIds.has(f.id)?'checked':''}></td>
          <td><strong>${escapeHtml(f.name)}</strong></td>
          <td class="small">${escapeHtml(f.filename || '')}</td>
          <td class="small">${escapeHtml(f.type || '')}</td>
          <td class="small">${escapeHtml((findUser(f.owner)||{}).name || '—')}</td>
          <td class="small">${new Date(f.createdAt).toLocaleString()}</td>
          <td class="small">${humanSize(f.size)}</td>
          <td class="row-actions">
            <button class="btn ghost" data-action="view" data-id="${f.id}">View</button>
            <button class="btn" data-action="download" data-id="${f.id}">Download</button>
            <button class="btn" data-action="share" data-id="${f.id}">Access</button>
          </td>`;
        filesTableBody.appendChild(tr);
      });

      stats.textContent = list.length + ' / ' + files.length + ' files shown';
    }

    function renderLogs(){
      logList.innerHTML = '';
      if(!logs.length){ logList.innerHTML = '<div class="small muted">No actions yet.</div>'; return; }
      logs.slice(0,30).forEach(l => {
        const d = document.createElement('div');
        d.style.padding='8px 0';
        d.innerHTML = `<div style="font-size:12px;color:#233">${l.ts}</div><div class="small muted">${escapeHtml(l.action)} ${l.meta?(' • ' + escapeHtml(l.meta)) : ''}</div>`;
        logList.appendChild(d);
      });
    }

    // ------------ table interaction (delegation) ------------
    filesTableBody.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if(!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if(action === 'view') openModal(id);
      if(action === 'download') downloadFile(id);
      if(action === 'share') openModal(id); // same modal includes access list
    });

    filesTableBody.addEventListener('change', e => {
      const cb = e.target.closest('.row-chk');
      if(cb){
        const id = cb.dataset.id;
        if(cb.checked) selectedIds.add(id); else selectedIds.delete(id);
        updateSelectAllState();
      }
    });

    selectAll.addEventListener('change', () => {
      const checkboxes = document.querySelectorAll('.row-chk');
      checkboxes.forEach(cb => { cb.checked = selectAll.checked; if(selectAll.checked) selectedIds.add(cb.dataset.id); else selectedIds.delete(cb.dataset.id); });
    });

    // ------------ bulk delete ------------
    bulkDeleteBtn.addEventListener('click', () => {
      if(selectedIds.size === 0){ alert('No files selected'); return; }
      if(!confirm(`Delete ${selectedIds.size} file(s)?`)) return;
      files = files.filter(f => !selectedIds.has(f.id));
      appendLog('Bulk delete files', Array.from(selectedIds).join(','));
      selectedIds.clear();
      save(FILE_KEY, files);
      renderAll();
    });

    // ------------ modal actions ------------
    function openModal(fileId){
      const f = files.find(x => x.id === fileId);
      if(!f) return;
      activeFileId = fileId;
      modalTitleInput.value = f.name;
      modalOwner.value = f.owner || '';
      modalNotes.value = f.notes || '';
      // populate access list checkboxes
      modalAccess.innerHTML = '';
      users.forEach(u => {
        const label = document.createElement('label');
        label.style.display='flex';
        label.style.alignItems='center';
        label.style.gap='8px';
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.dataset.user = u.id; if((f.access||[]).includes(u.id)) cb.checked = true;
        label.appendChild(cb);
        label.appendChild(document.createTextNode(' ' + u.name + ' ('+u.role+')'));
        modalAccess.appendChild(label);
      });

      // preview
      if(f.dataUrl && f.type.startsWith('image/')){
        previewBox.innerHTML = `<img src="${f.dataUrl}" alt="${escapeHtml(f.name)}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px">`;
      } else if(f.textPreview){
        previewBox.innerHTML = `<pre style="white-space:pre-wrap;padding:8px;color:var(--muted);line-height:1.4">${escapeHtml(f.textPreview)}</pre>`;
      } else {
        previewBox.innerHTML = `<div style="font-weight:700">${escapeHtml((f.type||'FILE').split('/')[0].toUpperCase())}</div>`;
      }

      modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false');
    }

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });

    function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); activeFileId = null; }

    modalDownload.addEventListener('click', () => { if(activeFileId) downloadFile(activeFileId); });
    modalRename.addEventListener('click', () => {
      if(!activeFileId) return;
      const f = files.find(x => x.id === activeFileId);
      const newTitle = prompt('Rename title', f.name);
      if(newTitle){ f.name = newTitle.trim(); save(FILE_KEY, files); renderTable(); appendLog('Renamed file', f.id); }
    });
    modalDelete.addEventListener('click', () => {
      if(!activeFileId) return;
      if(confirm('Delete this file?')){
        files = files.filter(x => x.id !== activeFileId);
        save(FILE_KEY, files); appendLog('Deleted file', activeFileId);
        closeModal(); renderAll();
      }
    });
    modalSave.addEventListener('click', () => {
      if(!activeFileId) return;
      const f = files.find(x => x.id === activeFileId);
      f.name = modalTitleInput.value.trim();
      f.owner = modalOwner.value;
      f.notes = modalNotes.value.trim();
      // access checkboxes
      const checked = Array.from(modalAccess.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.dataset.user);
      f.access = checked;
      save(FILE_KEY, files);
      appendLog('Updated file metadata', f.id);
      renderTable();
      alert('Saved.');
    });

    // ------------ download helper ------------
    function downloadFile(id){
      const f = files.find(x => x.id === id);
      if(!f) return;
      if(f.dataUrl){
        fetch(f.dataUrl).then(r => r.blob()).then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = f.filename || (f.name + '.bin'); a.click(); URL.revokeObjectURL(url);
          appendLog('Downloaded file', f.id);
        });
      } else {
        // create placeholder
        const blob = new Blob(['No preview available'], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = f.filename || (f.name + '.txt'); a.click(); URL.revokeObjectURL(url);
        appendLog('Downloaded file (placeholder)', f.id);
      }
    }

    // ------------ users management ------------
    addUserBtn.addEventListener('click', () => {
      const name = prompt('User full name');
      if(!name) return;
      const email = prompt('Email address for ' + name);
      if(!email) return;
      const role = prompt('Role (Admin / Instructor / Student)', 'Instructor');
      const id = uid('u');
      users.unshift({id, name: name.trim(), email: email.trim(), role: (role||'Instructor')});
      save(USER_KEY, users); appendLog('Added user', name);
      renderAll();
    });

    usersList.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if(!btn) return;
      const act = btn.dataset.action;
      const id = btn.dataset.id;
      if(act === 'edit-user'){
        const user = users.find(u => u.id === id);
        if(!user) return;
        const newName = prompt('New name', user.name);
        if(!newName) return;
        user.name = newName.trim();
        save(USER_KEY, users); appendLog('Edited user', user.id); renderAll();
      }
      if(act === 'del-user'){
        if(!confirm('Delete user? This will not remove their files.')) return;
        users = users.filter(u => u.id !== id);
        save(USER_KEY, users); appendLog('Deleted user', id); renderAll();
      }
    });

    // export users
    exportUsersBtn.addEventListener('click', () => {
      if(users.length === 0){ alert('No users'); return; }
      const rows = [['id','name','email','role']];
      users.forEach(u => rows.push([u.id,u.name,u.email,u.role]));
      downloadCSV(rows, 'users_export.csv');
    });

    // export logs
    exportLogBtn.addEventListener('click', () => {
      if(!logs.length){ alert('No logs'); return; }
      const rows = [['ts','action','meta']];
      logs.forEach(l => rows.push([l.ts,l.action,l.meta||'']));
      downloadCSV(rows, 'audit_logs.csv');
    });

    // export metadata
    exportMetaBtn.addEventListener('click', () => {
      if(files.length === 0){ alert('No files'); return; }
      const rows = [['id','name','filename','type','size','owner','access','notes','createdAt']];
      files.forEach(f => rows.push([f.id,f.name,f.filename||'',f.type,f.size, findUser(f.owner)?.email || '', (f.access || []).join(';'), (f.notes||''), new Date(f.createdAt).toISOString()]));
      downloadCSV(rows, 'files_metadata.csv');
    });

    function downloadCSV(rows, filename='export.csv'){
      const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    // ------------ logs panel ------------
    openLogsBtn.addEventListener('click', () => {
      const ln = logs.slice(0,200).map(l => `${l.ts} — ${l.action} ${l.meta?(' • '+l.meta):''}`).join('\n');
      alert('Audit Log (recent):\\n\\n' + (ln || 'No logs'));
    });

    // ------------ search / filters / sort / clear ------------
    [filterSearch, filterType, filterOwner, globalSearch, sortBy].forEach(el => el.addEventListener('input', renderTable));
    clearFilters.addEventListener('click', () => { filterSearch.value=''; filterType.value=''; filterOwner.value=''; renderTable(); });
    clearSearch.addEventListener('click', () => { globalSearch.value=''; renderTable(); });

    // ------------ utility buttons ------------
    document.getElementById('selectAll').addEventListener('change', function(){ const chks = document.querySelectorAll('.row-chk'); chks.forEach(c => { c.checked = this.checked; if(this.checked) selectedIds.add(c.dataset.id); else selectedIds.delete(c.dataset.id); }); });
    document.getElementById('clear-storage').addEventListener('click', () => {
      if(!confirm('Clear all demo data (files, users, logs) from localStorage?')) return;
      localStorage.removeItem(FILE_KEY); localStorage.removeItem(USER_KEY); localStorage.removeItem(LOG_KEY);
      files=[]; users=[]; logs=[];
      appendLog('Cleared demo storage');
      location.reload();
    });

    // helper: update selectAll checkbox state
    function updateSelectAllState(){
      const chks = Array.from(document.querySelectorAll('.row-chk'));
      const all = chks.length && chks.every(cb => cb.checked);
      document.getElementById('selectAll').checked = !!all;
    }

    // ------------ save/update handlers ------------
    function saveFiles(){
      save(FILE_KEY, files);
    }

    // append log helper wrapper
    function appendLog(msg, meta=''){ appendLogToStore(msg, meta); renderLogs(); save(LOG_KEY, logs); }
    function appendLogToStore(action, meta=''){ logs.unshift({ts: now(), action, meta}); save(LOG_KEY, logs); }

    // ------------ misc interactions ------------
    // row checkbox change
    document.addEventListener('change', e => {
      if(e.target.matches('.row-chk')){
        const id = e.target.dataset.id;
        if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
        updateSelectAllState();
      }
    });

    // row click -> view
    filesTableBody.addEventListener('dblclick', e => {
      const tr = e.target.closest('tr');
      if(!tr) return;
      const cb = tr.querySelector('.row-chk');
      if(cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
    });

    // initial render call
    function renderTable(){ renderAll(); /* renderAll already calls renderTable but harmless to call for safety */ }
    function renderAll(){ renderUsers(); populateOwnerSelectors(); renderLogs(); renderTable(); stats.textContent = files.length + ' files total'; }

    // small convenience: refresh rendering when saving files
    // hooking saveFiles to run renderAll after modification
    // (we already call save and render in each mutation path)

    // ------------------- Utility: appendLog wrapper name conflict fix -------------------
    // We used appendLog earlier as function; now real implementation:
    function appendLog(action, meta=''){ logs.unshift({ts: now(), action, meta}); save(LOG_KEY, logs); renderLogs(); }

    // End of script
  </script>
</body>
</html>
